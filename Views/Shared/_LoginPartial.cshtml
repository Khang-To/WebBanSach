@using WebBanSach.Models
@using Newtonsoft.Json
@inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
@inject WebBanSach.Models.ApplicationDbContext _context

@{
    int? userId = HttpContextAccessor.HttpContext.Session.GetInt32("Customer_UserId");

    AppUser user = null;
    int pendingPayments = 0;

    if (userId.HasValue)
    {
        user = _context.AppUsers.FirstOrDefault(x => x.ID == userId.Value);

        // Đếm số đơn hàng đã xác nhận => chờ thanh toán
        pendingPayments = _context.Orders
            .Where(o => o.UserId == userId.Value && o.Status == OrderStatus.Confirmed)
            .Count();
    }
}

@{
    int cartCount = 0;
    var session = HttpContextAccessor.HttpContext?.Session;

    // ĐÃ LOGIN → đếm từ DB
    if (userId.HasValue)
    {
        cartCount = _context.CartItems
            .Where(c => c.UserId == userId.Value)
            .Sum(c => c.Quantity);
    }
    // CHƯA LOGIN → đếm từ session
    else if (session != null)
    {
        string? jsonCart = session.GetString("shopcart");
        if (!string.IsNullOrEmpty(jsonCart))
        {
            try
            {
                var cartItems = JsonConvert.DeserializeObject<List<CartViewModel>>(jsonCart);
                cartCount = cartItems?.Sum(c => c.Quantity) ?? 0;
            }
            catch { cartCount = 0; }
        }
    }
}

@if (userId == null)
{
    <!-- Khi chưa đăng nhập -->
    <a asp-controller="Account" asp-action="Login" class="btn btn-outline-success"><i class="bi bi-person"></i> Đăng nhập </a>

    <a asp-controller="Cart" asp-action="ViewCart" class="btn btn-outline-success ms-3"><i class="bi bi-cart3"></i> Giỏ hàng <span class="badge bg-danger text-white ms-1 rounded-pill">@cartCount</span></a>
}
else
{
    <!-- Khi đã đăng nhập -->
    <div class="dropdown">
        <button class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle"></i> Xin chào, @user.FullName
        </button>

        <ul class="dropdown-menu dropdown-menu-en" style="z-index: 9999;">

            <li>
                <a class="dropdown-item" asp-controller="Account" asp-action="Profile">
                    <i class="bi bi-person-lines-fill"></i> Hồ sơ cá nhân
                </a>
            </li>

            <li>
                <a class="dropdown-item d-flex justify-content-between align-items-center"
                   asp-controller="Orders" asp-action="Index" asp-route-mode="payment">
                    <span>
                        <i class="bi bi-credit-card"></i> Thanh toán
                    </span>

                    @if (pendingPayments > 0)
                    {
                        <span class="badge bg-danger rounded-pill">
                            @pendingPayments
                        </span>
                    }
                </a>
            </li>

            <li>
                <a class="dropdown-item" asp-controller="Orders" asp-action="Index">
                    <i class="bi bi-receipt-cutoff"></i> Đơn hàng của tôi
                </a>
            </li>

            <li>
                <a asp-controller="Cart" asp-action="ViewCart" class="dropdown-item">
                    <i class="bi bi-cart3"></i> Giỏ hàng <span class="badge bg-danger text-white ms-1 rounded-pill">@cartCount</span>
                </a>
            </li>

            <li><hr class="dropdown-divider" /></li>

            <li>
                <a class="dropdown-item text-danger" asp-controller="Account" asp-action="Logout">
                    <i class="bi bi-box-arrow-right"></i> Đăng xuất
                </a>
            </li>

        </ul>
    </div>
}
