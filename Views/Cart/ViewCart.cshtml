@model List<CartViewModel>
@{
    ViewData["Title"] = "Giỏ hàng của bạn";
    int currentPage = (int)(ViewBag.CurrentPage ?? 1);
    int totalPages = (int)(ViewBag.TotalPages ?? 1);
    int totalItems = (int)(ViewBag.TotalItems ?? Model.Count);
    int pageSize = (int)(ViewBag.PageSize ?? 5);
}
<br />
<h3>Giỏ hàng của bạn (@totalItems sản phẩm)</h3>

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (Model.Count > 0 || totalItems > 0)
{
   <!-- Tính tổng tiền -->
    decimal tongtien = Model.Sum(i => i.Subtotal);

    <!-- Bảng giỏ hàng với chiều cao cố định và scroll -->
    <div class="table-responsive" style="max-height: 500px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem;">
        <table class="table table-striped mb-0">
            <thead class="table-light sticky-top">
                <tr>
                    <th>STT</th>
                    <th>Sản phẩm</th>
                    <th>Giá</th>
                    <th>Số lượng</th>
                    <th>Thành tiền</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @{
                    int stt = (currentPage - 1) * pageSize + 1;
                }
                @foreach (var i in Model)
                {
                    decimal thanhtien = i.Subtotal;
                    <tr class="align-middle">
                        <td>@(stt++)</td>
                        <td>
                            <img src="~/images/products/@i.Product.ImageUrl" class="img-thumbnail" width="50" alt="@i.Product.Name" />
                            @i.Product.Name
                        </td>
                        <td>@i.Product.FinalPrice.ToString("N0") đ</td>
                        <td>
                            @using (Html.BeginForm("UpdateItem", "Cart", FormMethod.Post))
                            {
                                @Html.AntiForgeryToken()
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        @Html.Hidden("id", i.Product.ID)
                                        <input name="quantity" type="number" value="@i.Quantity" min="1" max="@i.Product.Stock" class="form-control form-control-sm d-inline w-75" />
                                    </div>
                                    <div class="col-auto">
                                        <input class="btn btn-warning btn-sm" type="submit" value="Cập nhật" />
                                    </div>
                                </div>
                            }
                        </td>
                        <td>@thanhtien.ToString("N0") đ</td>
                        <td>
                            @using (Html.BeginForm("RemoveItem", "Cart", FormMethod.Post))
                            {
                                @Html.AntiForgeryToken()
                                @Html.Hidden("id", i.Product.ID)
                                <button type="submit" class="btn btn-danger btn-sm">Xóa</button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Tổng tiền -->
    <div class="row mt-3">
        <div class="col-12 text-end fw-bold">
            <h4>Tổng tiền: <strong class="text-danger">@tongtien.ToString("N0") đ</strong></h4>
        </div>
    </div>

    <!-- Phân trang nếu cần -->
    @if (totalPages > 1)
    {
        <nav aria-label="Phân trang giỏ hàng" class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" asp-action="ViewCart" asp-route-page="@(currentPage - 1)">Trước</a>
                </li>
                @for (int p = 1; p <= totalPages; p++)
                {
                    <li class="page-item @(p == currentPage ? "active" : "")">
                        <a class="page-link" asp-action="ViewCart" asp-route-page="@p">@p</a>
                    </li>
                }
                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <a class="page-link" asp-action="ViewCart" asp-route-page="@(currentPage + 1)">Sau</a>
                </li>
            </ul>
        </nav>
    }

    <!-- Nút hành động -->
    <div class="text-end mt-3 mb-5">
        <form asp-action="ConfirmOrder" method="post" style="display: inline-block;">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-primary">Xác nhận đặt hàng</button>
        </form>
        <a asp-action="Index" asp-controller="Products" class="btn btn-secondary ms-2">Tiếp tục mua sắm</a>
    </div>
}
else
{
    <div class="alert alert-info">
        <h5>Không có mặt hàng nào trong giỏ hàng</h5>
        <p>Giỏ hàng của bạn đang trống. Hãy thêm sản phẩm yêu thích để bắt đầu mua sắm!</p>
        <a asp-action="Index" asp-controller="Products" class="btn btn-primary">Tiếp tục mua sắm</a>
    </div>
}