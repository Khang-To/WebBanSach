@model WebBanSach.Models.Order

@{
    ViewData["Title"] = "Chi tiết đơn hàng #" + Model.ID;
}

<div class="container-fluid mt-4">
    <h2 class="mb-4">Chi tiết đơn hàng #@Model.ID</h2>

    <!-- Thông tin khách hàng -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Thông tin khách hàng</h5>
        </div>
        <div class="card-body">
            <dl class="row mb-0">
                <dt class="col-sm-3">Họ tên</dt>
                <dd class="col-sm-9">@Model.User?.FullName</dd>

                <dt class="col-sm-3">Số điện thoại</dt>
                <dd class="col-sm-9">@Model.User?.PhoneNumber</dd>

                <dt class="col-sm-3">Email</dt>
                <dd class="col-sm-9">@Model.User?.Email</dd>

                <dt class="col-sm-3">Địa chỉ</dt>
                <dd class="col-sm-9">@(Model.User?.Address ?? "Chưa cung cấp")</dd>

                <dt class="col-sm-3">Ngày đặt</dt>
                <dd class="col-sm-9">@Model.OrderDate.ToString("dd/MM/yyyy HH:mm")</dd>

                <dt class="col-sm-3">Trạng thái</dt>
                <dd class="col-sm-9">
                    <strong class="fs-5">@Html.DisplayFor(m => m.Status)</strong>
                </dd>
            </dl>
        </div>
    </div>

    <!-- Sản phẩm -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0">Sản phẩm đặt mua</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Tên sách</th>
                            <th class="text-center">SL</th>
                            <th class="text-end">Đơn giá</th>
                            <th class="text-end">Thành tiền</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{ var tongCong = 0m; }
                        @foreach (var item in Model.OrderDetails)
                        {
                            var thanhTien = item.Quantity * item.UnitPrice;
                            tongCong += thanhTien;
                            <tr>
                                <td>@item.?Product.Name</td>
                                <td class="text-center">@item.Quantity</td>
                                <td class="text-end">@item.UnitPrice.ToString("n0") ₫</td>
                                <td class="text-end fw-bold">@thanhTien.ToString("n0") ₫</td>
                            </tr>
                        }
                        <tr class="table-success fw-bold fs-5">
                            <td colspan="3" class="text-end">Tổng cộng:</td>
                            <td class="text-end text-danger">@tongCong.ToString("n0") ₫</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ghi chú khách hàng -->
    @if (!string.IsNullOrEmpty(Model.Note))
    {
        <div class="alert alert-light border mb-4">
            <strong>Ghi chú của khách:</strong><br />
            <pre class="mb-0" style="white-space: pre-wrap;">@Model.Note</pre>
        </div>
    }

    <!-- NÚT XỬ LÝ - LUÔN HIỆN, CHỈ DISABLE KHI KHÔNG ĐƯỢC PHÉP -->
    <div class="mt-4">

        <!-- Nút Xác nhận -->
        <form asp-action="UpdateStatus" method="post" class="d-inline">
            <input type="hidden" name="id" value="@Model.ID" />
            <input type="hidden" name="Status" value="Confirmed" />
            <button type="submit" 
                    class="btn btn-success btn-lg px-5"
                    @(Model.Status != OrderStatus.Pending ? "disabled" : "")>
                <i class="bi bi-check-circle-fill"></i> Xác nhận đơn hàng
            </button>
        </form>

        <form asp-action="UpdateStatus" method="post" class="d-inline ms-3">
            <input type="hidden" name="id" value="@Model.ID" />
            <input type="hidden" name="Status" value="Cancelled" />

            <button type="submit"
                    class="btn btn-danger btn-lg px-5"
                    @(Model.Status == OrderStatus.Paid || Model.Status == OrderStatus.Cancelled ? "disabled" : "")
                    @(Model.Status == OrderStatus.Paid || Model.Status == OrderStatus.Cancelled ? "" : "onclick=\"return confirm('Bạn chắc chắn muốn HỦY đơn hàng này?')\"")>
                <i class="bi bi-x-circle-fill"></i> Hủy đơn hàng
            </button>
        </form>

    </div>

    <div class="mt-4">
        <a asp-action="Index" class="btn btn-secondary btn-lg">
            <i class="bi bi-arrow-left"></i> Quay lại danh sách
        </a>
    </div>
</div>